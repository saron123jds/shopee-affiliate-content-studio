{% extends "base.html" %}
{% block content %}
<div class="card p-4">
  <div class="d-flex align-items-center justify-content-between">
    <div>
      <div class="fs-4 fw-semibold">Engajar vídeo</div>
      <div class="text-soft">Abra o vídeo várias vezes e registre as visualizações manualmente.</div>
    </div>
    <a class="btn btn-soft rounded-4" href="{{ url_for('videos') }}">Voltar</a>
  </div>

  <div class="mt-3">
    <div class="text-soft">Vídeo</div>
    <a href="{{ v.shopee_url }}" target="_blank" rel="noopener">{{ v.shopee_url }}</a>
  </div>

  <div class="mt-4 row g-3 align-items-end">
    <div class="col-lg-3">
      <label class="form-label text-soft">Quantidade</label>
      <input class="form-control" id="countInput" type="number" min="1" max="50" value="{{ count }}">
    </div>
    <div class="col-lg-9 d-flex gap-2">
      <button class="btn btn-light rounded-4" type="button" id="startEngage">Iniciar engajamento</button>
      <form method="post" action="{{ url_for('video_increment', vid=v.id) }}">
        <button class="btn btn-soft rounded-4" type="submit">Registrar 1 visualização</button>
      </form>
    </div>
  </div>

  <div class="alert alert-secondary rounded-4 border-0 mt-4">
    Dica: seu navegador pode bloquear pop-ups. Permita as janelas para abrir as repetições.
  </div>

  <div class="ratio ratio-16x9 mt-4">
    <iframe src="{{ v.shopee_url }}" title="Shopee video" allow="autoplay"></iframe>
  </div>
</div>

<script>
  const startBtn = document.getElementById("startEngage");
  const countInput = document.getElementById("countInput");
  startBtn.addEventListener("click", async () => {
    const count = Math.min(Math.max(parseInt(countInput.value || "1", 10), 1), 50);
    for (let i = 0; i < count; i += 1) {
      window.open("{{ v.shopee_url }}", "_blank");
    }
    await fetch("{{ url_for('video_bulk_increment', vid=v.id) }}", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ count: String(count) }),
    });
    window.location.reload();
  });
</script>
{% endblock %}
